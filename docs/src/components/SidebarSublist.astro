---
/**
 * Custom SidebarSublist with server-rendered icons
 * Based on Starlight's SidebarSublist.astro
 */

interface SidebarEntry {
  type: 'link' | 'group';
  label: string;
  href?: string;
  isCurrent?: boolean;
  badge?: { variant?: string; class?: string; text: string };
  attrs?: Record<string, any>;
  entries?: SidebarEntry[];
  collapsed?: boolean;
}

interface Props {
  sublist: SidebarEntry[];
  nested?: boolean;
}

const { sublist, nested } = Astro.props;

// Flatten sidebar entries to check if any child is current
function flattenSidebar(entries: SidebarEntry[]): SidebarEntry[] {
  return entries.flatMap((entry) => 
    entry.type === 'group' && entry.entries 
      ? [entry, ...flattenSidebar(entry.entries)] 
      : [entry]
  );
}

// Icon map for top-level sidebar items
const iconMap: Record<string, string> = {
  'Introduction': `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>`,
  'Getting Started': `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4.5 16.5c-1.5 1.26-2 5-2 5s3.74-.5 5-2c.71-.84.7-2.13-.09-2.91a2.18 2.18 0 0 0-2.91-.09z"/><path d="m12 15-3-3a22 22 0 0 1 2-3.95A12.88 12.88 0 0 1 22 2c0 2.72-.78 7.5-6 11a22.35 22.35 0 0 1-4 2z"/><path d="M9 12H4s.55-3.03 2-4c1.62-1.08 5 0 5 0"/><path d="M12 15v5s3.03-.55 4-2c1.08-1.62 0-5 0-5"/></svg>`,
  'Guides': `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"/></svg>`,
  'SDK Reference': `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>`,
  'API Reference': `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 0 1-9 9m9-9a9 9 0 0 0-9-9m9 9H3m9 9a9 9 0 0 1-9-9m9 9c1.66 0 3-4.03 3-9s-1.34-9-3-9m0 18c-1.66 0-3-4.03-3-9s1.34-9 3-9m-9 9a9 9 0 0 1 9-9"/></svg>`,
  'Enterprise': `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="16" height="20" x="4" y="2" rx="2" ry="2"/><path d="M9 22v-4h6v4"/><path d="M8 6h.01"/><path d="M16 6h.01"/><path d="M12 6h.01"/><path d="M12 10h.01"/><path d="M12 14h.01"/><path d="M16 10h.01"/><path d="M16 14h.01"/><path d="M8 10h.01"/><path d="M8 14h.01"/></svg>`,
};

// Caret icon for expandable groups
const caretIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="m9 18 6-6-6-6z"/></svg>`;

function getIcon(label: string): string | null {
  return iconMap[label] || null;
}
---

<ul class:list={{ 'top-level': !nested }}>
  {
    sublist.map((entry) => {
      const icon = !nested ? getIcon(entry.label) : null;
      
      return (
        <li>
          {entry.type === 'link' ? (
            <a
              href={entry.href}
              aria-current={entry.isCurrent ? 'page' : undefined}
              class:list={[{ large: !nested }, entry.attrs?.class]}
              {...entry.attrs}
            >
              {icon && <span class="sidebar-icon" set:html={icon} />}
              <span>{entry.label}</span>
              {entry.badge && (
                <span class:list={['sl-badge', entry.badge.variant, entry.badge.class]}>
                  {entry.badge.text}
                </span>
              )}
            </a>
          ) : (
            <details
              open={flattenSidebar(entry.entries || []).some((i) => i.isCurrent) || !entry.collapsed}
            >
              <summary>
                <span class="group-label">
                  {icon && <span class="sidebar-icon" set:html={icon} />}
                  <span class="large">{entry.label}</span>
                  {entry.badge && (
                    <span class:list={['sl-badge', entry.badge.variant, entry.badge.class]}>
                      {entry.badge.text}
                    </span>
                  )}
                </span>
                <span class="caret" set:html={caretIcon} />
              </summary>
              <Astro.self sublist={entry.entries || []} nested />
            </details>
          )}
        </li>
      );
    })
  }
</ul>

<style>
  ul {
    --sl-sidebar-item-padding-inline: 0.5rem;
    list-style: none;
    padding: 0;
  }

  li {
    overflow-wrap: anywhere;
  }

  ul ul li {
    margin-inline-start: var(--sl-sidebar-item-padding-inline);
    border-inline-start: 1px solid var(--sl-color-hairline-light);
    padding-inline-start: var(--sl-sidebar-item-padding-inline);
    margin-top: 0.25rem;
  }

  .large {
    font-size: var(--sl-text-lg);
    font-weight: 600;
    color: var(--sl-color-white);
  }

  .top-level > li + li {
    margin-top: 0.75rem;
  }

  summary {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.2em var(--sl-sidebar-item-padding-inline);
    line-height: 1.4;
    cursor: pointer;
    user-select: none;
  }
  summary::marker,
  summary::-webkit-details-marker {
    display: none;
  }

  .caret {
    transition: transform 0.2s ease-in-out;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    color: var(--sl-color-gray-3);
  }
  :global([dir='rtl']) .caret {
    transform: rotateZ(180deg);
  }
  [open] > summary .caret {
    transform: rotateZ(90deg);
  }

  a {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    border-radius: 0.25rem;
    text-decoration: none;
    color: var(--sl-color-gray-2);
    padding: 0.3em var(--sl-sidebar-item-padding-inline);
    line-height: 1.4;
  }

  a:hover,
  a:focus {
    color: var(--sl-color-white);
  }

  [aria-current='page'],
  [aria-current='page']:hover,
  [aria-current='page']:focus {
    font-weight: 600;
    color: var(--sl-color-text-invert);
    background-color: var(--sl-color-text-accent);
  }

  a > *:not(:last-child),
  .group-label > *:not(:last-child) {
    margin-inline-end: 0.25em;
  }

  /* Sidebar icon styling */
  .sidebar-icon {
    flex-shrink: 0;
    width: 16px;
    height: 16px;
    opacity: 0.6;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  /* Active state for icons */
  [aria-current='page'] .sidebar-icon,
  [open] > summary .sidebar-icon {
    opacity: 1;
  }

  /* Group label needs flex */
  .group-label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  /* Badge styling */
  .sl-badge {
    font-size: 0.75rem;
    padding: 0.125rem 0.375rem;
    border-radius: 0.25rem;
    background: var(--sl-color-accent-low);
    color: var(--sl-color-accent-high);
  }

  @media (min-width: 50rem) {
    .top-level > li + li {
      margin-top: 0.5rem;
    }
    .large {
      font-size: var(--sl-text-base);
    }
    a {
      font-size: var(--sl-text-sm);
    }
  }
</style>
